var H=Object.defineProperty;var J=(r,n,s)=>n in r?H(r,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[n]=s;var f=(r,n,s)=>J(r,typeof n!="symbol"?n+"":n,s);import{c as $,o as k,a as w,b as v,u as b,aJ as B,t as O,aG as N,aW as S,G as X,i as Y,g as D,h as Z,e as T,f as F,y as K,w as V,q,aI as u,j as G,R as Q,bc as x,aN as R,bd as y,be as ss,N as es,T as ts,bf as U,P as j,bg as P,Y as A,Z as W,V as g,aM as E,bh as as,bi as os,l as _,bj as is,bk as rs,I as ns,bl as cs,bm as ds,bn as ms}from"./index-DI_G0BoI.js";import{t as d}from"./appTxt-9k9YIZ7X.js";const ls=["src"],us={class:"row unset around"},hs=["href"],fs=["src"],_s={__name:"MyItem1B",props:["x"],setup(r){return(n,s)=>(k(),$(D,null,[w("img",{class:"logo preview",src:b(B)(r.x.logo||r.x.photo)},null,8,ls),w("div",{class:"blue bold ctr1",style:N(b(S)(r.x))},O(r.x.name),5),v(X,{class:"row ctr",dic:r.x._info},null,8,["dic"]),v(Y,{class:"row ctr m10 scroll",md:r.x.info},null,8,["md"]),w("div",us,[(k(!0),$(D,null,Z(r.x.team,e=>{var a;return k(),$("div",{key:e.role,class:"ctr1 m10"},[w("a",{class:"link",href:e._link},[w("img",{class:"logo3",src:b(B)(e.photo)||e.img},null,8,fs),v(K,{v:e.role},null,8,["v"]),w("div",{style:N(b(S)(e)),class:"pre"},O((a=e.name)==null?void 0:a.replace(" ",`
`)),5)],8,hs),e.uid?F("",!0):(k(),T(G,{key:0,c:"grey",onClick:t=>r.x._crudRole(e.role)},{default:V(()=>[q(O(b(u).claim),1)]),_:2},1032,["onClick"])),r.x.role==e.role?(k(),T(G,{key:1,onClick:s[0]||(s[0]=t=>r.x._crudRole(null))},{default:V(()=>[q(O(b(u).leave),1)]),_:1})):F("",!0)])}),128))])],64))}};class ps{constructor(){f(this,"host",Q.apiHost);f(this,"me",{uid:"",name:""})}async post(n="",s){var t;const{me:e}=this;for(["delete","refund"].includes(s==null?void 0:s.act)&&await x();!R.ready;)await y(50);return n.includes("crud")&&n!="crudUser"&&!e.name&&await this.crudUser(),await ss(s,o=>this.upload(o)),(await es.post(this.host+n,s,{headers:{Authorization:`Bearer ${((t=R.user)==null?void 0:t.token)||""}`}})).data}async upload(n){if(!ts(n))return n;const s=new FormData;return s.append("file",n),await this.post("upload",s)}async readMe(){this.me=await this.post("crudUser"),console.log("me",this.me)}async crudUser(n){R.user||await R.signIn(),await this.readMe();const s=async(e,a)=>{this.me=await this.post("crudUser",{act:e,data:a})};await U(u.userConf,n||this.me,s)}async crudComment(n,s,e){const a=async(t,o)=>{await this.post("crudItem",{act:t,data:o,table:"comments"})};await U(u.conf[e],{tbl:n,row_id:s,type:e},a)}}const z={name:"AI",photo:d.app.logo};function L(r=[],n){var a;const s=["CEO","CTO","CPO","CMO"];r.forEach(t=>t._link=`/user?uid=${t.uid}`),r=s.map(t=>{const o=r.find(i=>i.role==t)||{role:t};return o.img=`/ui/icons/${t}.png`,o});const e=(a=r.find(t=>t.uid==n))==null?void 0:a.role;return[r,e]}class gs extends ps{constructor(){super(...arguments);f(this,"tab","home");f(this,"rooms",{explore:[],mine:[],stars:[]});f(this,"roomsMap",{});f(this,"curRoomId",null);f(this,"sortBy",d.sortItems[0]);f(this,"query","")}async crudRoom(s={public:!0,tier:0}){const e=async t=>{this.tab="mine",await this.readRooms(),await y(1e3),A.push(`/startup?id=${t}`);const i=this.getRoom(t,{_tab:"info"});await y(1e3),await i._crudRole("CEO"),await y(1e3),i._tab="play",await y(1e3);const m={md:d.founded(i.name)};await this.crudMsg(i,"check",m,"discussion"),await y(1e3),await this.crudAIMsg(i)},a=async(t,o)=>{o=_.omit(o,["tier"]);const i=await this.post("crudItem",{act:t,data:o,table:"rooms"});Object.assign(s,o),t=="check"&&!o.id&&e(i.id)};await U(d.roomConf,s,a)}async readRooms(s){let{tab:e,rooms:a,sortBy:t,query:o}=this;t=t.value,o=o.trim();const i=s?Object.keys(a):[e];for(let m of i){const p=a[m]||[],c=p.length,l=await this.post("readRooms",{tab:m,skip:c,sortBy:t,query:o});a[m]=p.concat(l),a[m].forEach((C,h)=>a[m][h]=this.getRoom(C.id,C))}}readRoom(s){return this.post("readRoom",{id:s}).then(e=>e.id?this.getRoom(s,e):A.push("/")),this.getRoom(s)}readUser(s){if(s=="AI")return{uid:s,...d.app};const e=j({});return this.post("readUser",{uid:s}).then(a=>Object.assign(e,a)),e}getRoom(s,e={}){const{roomsMap:a}=this;return a[s]||(a[s]=j({})),Object.assign(a[s],e),this.modifyRoom(a[s])}modifyRoom(s){var t;const{me:e}=this;if(s.id==null)return s;s._tab||(s._tab="play"),s._link=`/startup?id=${s.id}`;const a=s._menu=[];return s.is_my&&a.push({text:u.edit,cb:()=>this.crudRoom(s)}),a.push({text:u.report,cb:()=>this.crudComment("rooms",s.id,"report")}),s._clear=()=>{W(d.clearConfirm,u.confirm,async()=>{if(s.role!="CEO")return g.create(d.ceoOnly);await this.post("clearRoom",{id:s.id})})},s._metrics={VAL:E(s.val),MRR:E(s.mrr),Cash:E(s.cash)},s._info=d.roomPayInfo(s),s._refund=async()=>{if(as(s.ts)>7)return g.create(d.noRefund);const o=await this.post("crudItem",{act:"refund",data:{id:s.id},table:"rooms"});y(1e3).then(()=>W(d.refunded(o.refund))),os.show=!1},s._crudStar=async()=>{Object.assign(s,await this.post("crudStar",{id:s.id}))},[s.team,s.role]=L(s.team,e.uid),s._crudRole=async o=>{const{msg:i,team:m}=await this.post("crudRole",{id:s.id,role:o});i&&g.create(d[i]),[s.team,s.role]=L(m,e.uid)},s._msgEdit={},(t=s.msgs)==null||t.forEach(o=>{o._link=`/user?uid=${o.uid}`;const i=o._menu=[];if(o.is_my){const m=["is_my","user","_menu","_link"];i.push({text:u.edit,cb:()=>s._msgEdit=_.omit(_.cloneDeep(o),m)})}o.uid=="AI"&&(o.user=z,i.push({text:u.delete,cb:()=>this.crudAIMsg(s,"delete",o)})),i.push({text:u.report,cb:()=>this.crudComment("msgs",s.id,"report")})}),s}async search(){const{rooms:s,tab:e}=this;s[e]=[],await this.readRooms()}async crudMsg(s,e,a,t){if(a={type:t,room_id:s.id,role:s.role,...a},a.type!="comment"&&!a.role)return g.create(d.roleNeeded);await this.post("crudItem",{act:e,data:a,user:_.omit(this.me,["info"]),table:"msgs"})}async crudAIMsg(s,e="check",a){const{role:t,id:o,pay:i}=s;if(i&&!i.paid&&(await is(i),await this.readRoom(o)),t!="CEO")return g.create(d.ceoOnly);await this.post("crudAIMsg",{act:e,data:{room_id:o,...a}})}async readMsgs(s,e,a){const t=await this.post("readMsgs",{id:s.id,tab:e,before:a});s.msgs=s.msgs.concat(t),this.modifyRoom(s)}initWS(){const s=this.host+"chat",e=async t=>{var C;const{rooms:o}=this,{roomId:i,type:m,act:p,data:c}=t;c.uid&&(c.is_my=R.user.uid==c.uid);const l=this.getRoom(i);if(m=="crudMsg"){if(c.uid=="AI"&&(l.tempMsg=void 0),c.is_my||(l.n_unread+=1),i!=this.curRoomId){const h=p=="delete"?"❌ ":"",I=((C=c.user)==null?void 0:C.name)||c.uid;g.create(`${h}${I}@${l.name}: ${cs.truncate(ds(ms(c.md)))}`)}if(!l.msgs)return;if(p=="create")l.msgs.push(c);else if(p=="update"){const h=l.msgs.find(I=>I.id==c.id);Object.assign(h||{},c)}else p=="delete"&&(l.msgs=l.msgs.filter(h=>h.id!=c.id))}else m=="crudRoom"?(Object.assign(l,c),p=="delete"&&(Object.keys(o).forEach(h=>{o[h]=o[h].filter(I=>I.id!=c.id)}),A.push("/"),g.create(u.deleted(c.name)))):m=="msgDelta"&&(l.tempMsg||(l.tempMsg={type:"scenario",md:"",ts:Date.now(),user:z}),l.tempMsg.md+=c.delta);m!="msgDelta"&&this.getRoom(i)};this.ws=rs(s,{onMsg:e}),ns(()=>{const{curRoomId:t,rooms:o}=this;return _.uniq(_.compact([t,...o.mine.map(i=>i.id+"")]))},t=>{console.log("setRooms",t),this.ws.send({setRooms:t})})}}const M=j(new gs);R.onChange(async()=>{M.initWS(),await M.readMe(),await M.readRooms(!0)});async function Rs(){M.me.name||await M.crudUser({photo:await P(d.app.logo),sex:"M",name:"Cat",info:"I am a cat"}),await M.crudRoom({logo:await P(d.app.logo),name:d.app.name,info:d.app.info,public:!0,tier:1})}export{_s as _,Rs as a,M as t};
